# name: Helm Charts Push to AWS ECR

# on:
#   push:
#     tags:
#     - "v[0-9]+.[0-9]+.[0-9]+"
#     - "v[0-9]+.[0-9]+.[0-9]+-*"
#   pull_request_target:
#     branches:
#     - "*"

# jobs:
#   tag-validate:
#     runs-on: ubuntu-latest
#     if: startsWith(github.ref, 'refs/tags/v')
#     steps:
#     - uses: rubenesp87/semver-validation-action@0.1.0
#       with:
#        version: ${{ github.ref_name }}

#   helm_push_to_ecr:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v2

#       - name: Set up AWS Credentials
#         uses: aws-actions/configure-aws-credentials@v2
#         with:
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           aws-region: us-east-1

#       - name: Install Helm
#         run: |
#           curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
#           chmod 700 get_helm.sh
#           ./get_helm.sh

#       - name: Login to AWS ECR
#         run: |
#           aws ecr-public get-login-password --region us-east-1 | helm registry login --username AWS --password-stdin ${{secrets.REPO}}

#       - name: Package k8s-risk-assessment-job
#         run: |
#           helm package k8s-risk-assessment-job
#           CHART_PACKAGE_1=$(ls k8s-risk-assessment-job-*.tgz)
#           echo "CHART_PACKAGE_1=$CHART_PACKAGE_1" >> $GITHUB_ENV

#       - name: Package k8tls-job
#         run: |
#           helm package k8tls-job
#           CHART_PACKAGE_2=$(ls k8tls-job-*.tgz)
#           echo "CHART_PACKAGE_2=$CHART_PACKAGE_2" >> $GITHUB_ENV

#       - name: Package kiem-job
#         run: |
#           helm package kiem-job
#           CHART_PACKAGE_3=$(ls kiem-job-*.tgz)
#           echo "CHART_PACKAGE_3=$CHART_PACKAGE_3" >> $GITHUB_ENV

#       - name: Push Helm Chart 1 to ECR
#         run: |
#           helm push ${{ env.CHART_PACKAGE_1 }} oci://${{ secrets.REPO }}

#       - name: Push Helm Chart 2 to ECR
#         run: |
#           helm push ${{ env.CHART_PACKAGE_2 }} oci://${{ secrets.REPO }}

#       - name: Push Helm Chart 3 to ECR
#         run: |
#           helm push ${{ env.CHART_PACKAGE_3 }} oci://${{ secrets.REPO }}







name: Helm Charts Push to AWS ECR

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"  # Match tags like v1.0.0
      - "v[0-9]+.[0-9]+.[0-9]+-*"
  pull_request_target:
    branches:
      - "*"  # This ensures it runs on all branches for pull requests

jobs:
  tag-validate:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Validate Tag Format
        uses: rubenesp87/semver-validation-action@0.1.0
        with:
          version: ${{ github.ref_name }}

  helm_push_to_ecr:
    runs-on: ubuntu-latest
    needs: tag-validate  # Ensure this job runs after tag validation

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Install Helm
        run: |
          curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
          chmod 700 get_helm.sh
          ./get_helm.sh

      - name: Extract Tag Version
        id: extract_version
        run: |
          TAG_NAME="${{ github.ref_name }}"  # e.g., v1.2.3
          VERSION="${TAG_NAME}"  # Remove leading 'v'
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Update Helm Chart Version for k8s-risk-assessment-job
        run: |
          sed -i "s/^version:.*$/version: ${{ env.VERSION }}/" k8s-risk-assessment-job/Chart.yaml

      - name: Package k8s-risk-assessment-job
        run: |
          helm package k8s-risk-assessment-job
          CHART_PACKAGE_1=$(ls k8s-risk-assessment-job-*.tgz)
          echo "CHART_PACKAGE_1=$CHART_PACKAGE_1" >> $GITHUB_ENV

      - name: Update Helm Chart Version for k8tls-job
        run: |
          sed -i "s/^version:.*$/version: ${{ env.VERSION }}/" k8tls-job/Chart.yaml

      - name: Package k8tls-job
        run: |
          helm package k8tls-job
          CHART_PACKAGE_2=$(ls k8tls-job-*.tgz)
          echo "CHART_PACKAGE_2=$CHART_PACKAGE_2" >> $GITHUB_ENV

      - name: Update Helm Chart Version for kiem-job
        run: |
          sed -i "s/^version:.*$/version: ${{ env.VERSION }}/" kiem-job/Chart.yaml

      - name: Package kiem-job
        run: |
          helm package kiem-job
          CHART_PACKAGE_3=$(ls kiem-job-*.tgz)
          echo "CHART_PACKAGE_3=$CHART_PACKAGE_3" >> $GITHUB_ENV

      - name: Login to AWS ECR
        run: |
          aws ecr-public get-login-password --region us-east-1 | helm registry login --username AWS --password-stdin ${{secrets.REPO}}

      - name: Push k8s-risk-assessment-job to ECR
        run: |
          helm push ${{ env.CHART_PACKAGE_1 }} oci://${{ secrets.REPO }}

      - name: Push k8tls-job to ECR
        run: |
          helm push ${{ env.CHART_PACKAGE_2 }} oci://${{ secrets.REPO }}

      - name: Push kiem-job to ECR
        run: |
          helm push ${{ env.CHART_PACKAGE_3 }} oci://${{ secrets.REPO }}

